/**
 * @name install_cache_threat
 * @description Query
 * @kind problem
 * @problem.severity error
 * @security-severity 9.0
 * @precision low
 * @id npm/node-dvnr
 * @tags security
 *       script
 *       cache
 */

import javascript


// Install of some package
bindingset[script]
predicate suspiciousPackage(string script) {
    script.matches("npm install %tastytreats%")
}


// Execution of some command
bindingset[script]
predicate suspiciousCommand(string script) {
    script.matches("%`npm get cache`%")
    or
    script.matches("%$(npm get cache)%")
}


from JSONObject json, string script
where exists( PackageJSON manifest | json = manifest.getScripts() )
  and script = json.getPropStringValue( [ "preinstall"
                                        , "install"
                                        , "postinstall"
                                        ]
                                      )
  and ( suspiciousPackage(script) or suspiciousCommand(script) )
select json, "SCRIPT: " + "( " + script + " )"
