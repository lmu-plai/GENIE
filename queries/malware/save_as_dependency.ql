/**
 * @name save_as_dependency
 * @description Query
 * @kind problem
 * @problem.severity error
 * @security-severity 9.0
 * @precision low
 * @id npm/aframe-vimeo-component
 * @tags security
 *       script
 *       request
 */

import javascript


// Use of library 'requests' (npmjs.com/package/requests)
class Requests extends ClientRequest::Range {
    // CharPred
    Requests() {
        exists( DataFlow::ModuleImportNode requests
              | requests = DataFlow::moduleImport("requests")
              | requests.flowsTo( this.getCalleeNode() )
              )
    }

    override DataFlow::Node getUrl() {
        result = this.getArgument(0)
    }

    override DataFlow::Node getHost() {
        result = this.getArgument(0)
    }

    override DataFlow::Node getADataNode() {
        result = this.getOptionArgument(1, "headers")
    }
}


string relevant_script() {
    exists( PackageJSON manifest, JSONObject json
          | json = manifest.getScripts()
          | result = json.getPropStringValue( [ "", "pre", "post" ]
                                              +
                                              [ "test", "install" ]
                                            )
          )
}


predicate save_dependency(string script, string file) {
    script = relevant_script()
    and
    script = ["node ", "npm install "] + file + [ " --save-prod"
                                                , " --save-dev"
                                                , " --save-optional"
                                                , " -P"
                                                , " -D"
                                                , " -O"
                                                ]
}


from ClientRequest request, string script, string file
where save_dependency(script, file)
  // Note ---> .getRelativePath() won't work in fuzzing server
  and request.getFile().getBaseName() = file
select request, "SCRIPT: " + "( " + script + " )"
